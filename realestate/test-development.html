<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMKO Development Testing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log { 
            background: #f8f9fa; 
            padding: 10px; 
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üöÄ OMKO Real Estate - Development Testing</h1>
    
    <div class="status info" id="env-status">
        <strong>üîß Environment Status:</strong> <span id="env-info">Loading...</span>
    </div>

    <div class="test-section">
        <h2>üì° API Connectivity Tests</h2>
        <button onclick="testBackendConnection()">Test Backend Connection</button>
        <button onclick="testSystemSettings()">Test System Settings API</button>
        <button onclick="testAllApis()">Test All APIs</button>
        <div id="api-results"></div>
    </div>

    <div class="test-section">
        <h2>üî• Firebase Tests</h2>
        <button onclick="testFirebaseConnection()">Test Firebase Connection</button>
        <button onclick="requestNotificationPermission()">Request Notification Permission</button>
        <div id="firebase-results"></div>
    </div>

    <div class="test-section">
        <h2>üìç Google Maps Tests</h2>
        <button onclick="testGoogleMaps()">Test Google Maps API</button>
        <div id="maps-results"></div>
    </div>

    <div class="test-section">
        <h2>üìä Configuration Debug</h2>
        <button onclick="showConfig()">Show Current Configuration</button>
        <div id="config-results"></div>
    </div>

    <div class="test-section">
        <h2>üìù Console Logs</h2>
        <div id="console-logs" class="log"></div>
    </div>

    <!-- Include API Config -->
    <script type="module" src="api-config.js"></script>
    <script type="module" src="firebase-config.js"></script>

    <script>
        // Override console.log to capture logs
        const originalLog = console.log;
        const logDiv = document.getElementById('console-logs');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logEntry = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + logEntry + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        // Initialize environment info
        document.addEventListener('DOMContentLoaded', function() {
            const envInfo = document.getElementById('env-info');
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            
            let environment = 'Unknown';
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                environment = 'üîß Development (Local)';
            } else if (hostname.includes('omko.do')) {
                environment = 'üåê Production';
            }
            
            envInfo.innerHTML = `${environment} - ${protocol}//${hostname}${port ? ':' + port : ''}`;
            console.log('üåç Environment detected:', environment);
        });

        // Test functions
        async function testBackendConnection() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="status info">Testing backend connection...</div>';
            
            try {
                // Use dynamic import to get API config
                const { API_BASE_URL } = await import('./api-config.js');
                const backendUrl = window.location.hostname === 'localhost' ? 
                    'http://localhost:8000' : 'https://adminrealestate.omko.do/public';
                
                console.log('üîç Testing backend at:', backendUrl);
                
                const response = await fetch(`${backendUrl}/api/get_system_settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                if (response.ok) {
                    resultsDiv.innerHTML = '<div class="status success">‚úÖ Backend connection successful!</div>';
                    console.log('‚úÖ Backend response OK');
                } else {
                    resultsDiv.innerHTML = `<div class="status error">‚ùå Backend error: ${response.status}</div>`;
                    console.log('‚ùå Backend error:', response.status);
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Connection failed: ${error.message}</div>`;
                console.log('‚ùå Backend connection error:', error);
            }
        }

        async function testSystemSettings() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="status info">Testing system settings API...</div>';
            
            try {
                const backendUrl = window.location.hostname === 'localhost' ? 
                    'http://localhost:8000' : 'https://adminrealestate.omko.do/public';
                
                const response = await fetch(`${backendUrl}/api/get_system_settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.error === false) {
                        resultsDiv.innerHTML = `
                            <div class="status success">‚úÖ System Settings API working!</div>
                            <div class="log">
                                <strong>Company:</strong> ${data.data.company_name}<br>
                                <strong>Version:</strong> ${data.data.system_version}<br>
                                <strong>Currency:</strong> ${data.data.currency_symbol}
                            </div>
                        `;
                        console.log('‚úÖ System settings loaded:', data.data);
                    } else {
                        resultsDiv.innerHTML = `<div class="status error">‚ùå API returned error: ${data.message}</div>`;
                    }
                } else {
                    resultsDiv.innerHTML = `<div class="status error">‚ùå API error: ${response.status}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Request failed: ${error.message}</div>`;
                console.log('‚ùå System settings error:', error);
            }
        }

        async function testFirebaseConnection() {
            const resultsDiv = document.getElementById('firebase-results');
            resultsDiv.innerHTML = '<div class="status info">Testing Firebase connection...</div>';
            
            try {
                // Test if Firebase is loaded
                if (typeof firebase !== 'undefined' || window.firebase) {
                    resultsDiv.innerHTML = '<div class="status success">‚úÖ Firebase loaded successfully!</div>';
                    console.log('‚úÖ Firebase available');
                } else {
                    resultsDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è Firebase not detected. Check configuration.</div>';
                    console.log('‚ö†Ô∏è Firebase not available');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Firebase error: ${error.message}</div>`;
                console.log('‚ùå Firebase error:', error);
            }
        }

        async function testGoogleMaps() {
            const resultsDiv = document.getElementById('maps-results');
            resultsDiv.innerHTML = '<div class="status info">Testing Google Maps...</div>';
            
            try {
                if (typeof google !== 'undefined' && google.maps) {
                    resultsDiv.innerHTML = '<div class="status success">‚úÖ Google Maps API loaded!</div>';
                    console.log('‚úÖ Google Maps available');
                } else {
                    resultsDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è Google Maps not loaded. Check API key.</div>';
                    console.log('‚ö†Ô∏è Google Maps not available');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Maps error: ${error.message}</div>`;
                console.log('‚ùå Google Maps error:', error);
            }
        }

        async function showConfig() {
            const resultsDiv = document.getElementById('config-results');
            
            try {
                const configInfo = {
                    hostname: window.location.hostname,
                    port: window.location.port,
                    protocol: window.location.protocol,
                    userAgent: navigator.userAgent.substring(0, 50) + '...'
                };
                
                resultsDiv.innerHTML = `
                    <div class="status info">Current Configuration:</div>
                    <div class="log">${JSON.stringify(configInfo, null, 2)}</div>
                `;
                
                console.log('üîß Current configuration:', configInfo);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Config error: ${error.message}</div>`;
            }
        }

        async function requestNotificationPermission() {
            const resultsDiv = document.getElementById('firebase-results');
            
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    resultsDiv.innerHTML = '<div class="status success">‚úÖ Notification permission granted!</div>';
                    console.log('‚úÖ Notifications enabled');
                } else {
                    resultsDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è Notification permission denied.</div>';
                    console.log('‚ö†Ô∏è Notifications disabled');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Permission error: ${error.message}</div>`;
                console.log('‚ùå Notification error:', error);
            }
        }

        async function testAllApis() {
            console.log('üîÑ Starting comprehensive API testing...');
            await testBackendConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testSystemSettings();
        }
    </script>
</body>
</html>